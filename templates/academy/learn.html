{% extends "base.html" %}

{% block title %}{{ current_lesson.title if current_lesson else course.title }} - Chengeta Academy{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/academy.css') }}">
{% endblock %}

{% block content %}
<div class="learn-page">
    <!-- Video/Content Area -->
    <div class="learn-main">
        <div class="video-container">
            {% if current_lesson %}
                {% if current_lesson.content_type == 'video' and current_lesson.video_url %}
                <iframe 
                    src="{{ current_lesson.get_video_embed_url() }}" 
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen>
                </iframe>
                {% elif current_lesson.content_type == 'text' %}
                <div class="text-content">
                    {{ current_lesson.text_content|safe }}
                </div>
                {% else %}
                <div class="no-content">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <polygon points="23 7 16 12 23 17 23 7"/>
                        <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                    </svg>
                    <p>Content coming soon...</p>
                </div>
                {% endif %}
            {% else %}
            <div class="no-content">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                </svg>
                <h3>Welcome to {{ course.title }}</h3>
                <p>Select a lesson from the sidebar to begin learning</p>
            </div>
            {% endif %}
        </div>

        <!-- Lesson Info -->
        {% if current_lesson %}
        <div class="lesson-info-bar">
            <div class="lesson-title">
                <h2>{{ current_lesson.title }}</h2>
                <span class="duration">{{ current_lesson.duration_minutes }} minutes</span>
            </div>
            <div class="lesson-actions">
                {% set lesson_progress = progress_map.get(current_lesson.id) %}
                {% if lesson_progress and lesson_progress.is_completed %}
                <button class="btn-completed" disabled>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    Completed
                </button>
                {% else %}
                <button class="btn-complete" onclick="markComplete({{ current_lesson.id }})">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/><path d="M9 12l2 2 4-4"/>
                    </svg>
                    Mark Complete
                </button>
                {% endif %}
            </div>
        </div>

        <!-- Lesson Description -->
        {% if current_lesson.description %}
        <div class="lesson-description">
            <h3>About This Lesson</h3>
            <p>{{ current_lesson.description }}</p>
        </div>
        {% endif %}

        <!-- Resources -->
        {% if current_lesson.get_resources() %}
        <div class="lesson-resources">
            <h3>Resources</h3>
            <div class="resources-list">
                {% for resource in current_lesson.get_resources() %}
                <a href="{{ resource.url }}" class="resource-item" target="_blank">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    {{ resource.name }}
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Navigation -->
        <div class="lesson-navigation">
            {% set prev_lesson = None %}
            {% set next_lesson = None %}
            {% for i, lesson in enumerate(lessons) %}
                {% if lesson.id == current_lesson.id %}
                    {% if i > 0 %}
                        {% set prev_lesson = lessons[i-1] %}
                    {% endif %}
                    {% if i < lessons|length - 1 %}
                        {% set next_lesson = lessons[i+1] %}
                    {% endif %}
                {% endif %}
            {% endfor %}
            
            <a href="{% if prev_lesson %}{{ url_for('academy.learn', slug=course.slug, lesson=prev_lesson.id) }}{% else %}#{% endif %}" 
               class="nav-btn prev {{ 'disabled' if not prev_lesson }}">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Previous Lesson
            </a>
            <a href="{% if next_lesson %}{{ url_for('academy.learn', slug=course.slug, lesson=next_lesson.id) }}{% else %}#{% endif %}" 
               class="nav-btn next {{ 'disabled' if not next_lesson }}">
                Next Lesson
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Sidebar - Curriculum -->
    <div class="learn-sidebar">
        <div class="sidebar-header">
            <a href="{{ url_for('academy.course_detail', slug=course.slug) }}" class="back-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Back to Course
            </a>
            <h3>{{ course.title }}</h3>
            <div class="progress-overview">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ enrollment.progress_percent }}%"></div>
                </div>
                <span>{{ enrollment.progress_percent }}% complete</span>
            </div>
        </div>

        <div class="curriculum-list">
            {% for lesson in lessons %}
            {% set lesson_prog = progress_map.get(lesson.id) %}
            <a href="{{ url_for('academy.learn', slug=course.slug, lesson=lesson.id) }}" 
               class="curriculum-item {{ 'active' if current_lesson and lesson.id == current_lesson.id }} {{ 'completed' if lesson_prog and lesson_prog.is_completed }}">
                <div class="item-status">
                    {% if lesson_prog and lesson_prog.is_completed %}
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    {% else %}
                    <span class="lesson-num">{{ loop.index }}</span>
                    {% endif %}
                </div>
                <div class="item-info">
                    <span class="item-title">{{ lesson.title }}</span>
                    <span class="item-duration">{{ lesson.duration_minutes }} min</span>
                </div>
                {% if current_lesson and lesson.id == current_lesson.id %}
                <div class="now-playing">
                    <span class="pulse"></span>
                </div>
                {% endif %}
            </a>
            {% endfor %}
        </div>

        {% if enrollment.is_completed %}
        <div class="completion-card">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>
            </svg>
            <h4>Congratulations!</h4>
            <p>You've completed this course</p>
            <a href="{{ url_for('academy.certificate', enrollment_id=enrollment.id) }}" class="btn-certificate">
                Get Certificate
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script>
function markComplete(lessonId) {
    fetch(`/academy/lesson/${lessonId}/complete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload to show updated progress
            window.location.reload();
        }
    })
    .catch(error => console.error('Error:', error));
}

// Track video progress (optional - for more detailed tracking)
function updateProgress(lessonId, watchTime) {
    fetch(`/academy/lesson/${lessonId}/progress`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ watch_time: watchTime })
    });
}
</script>
{% endblock %}

